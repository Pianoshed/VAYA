<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard â€” Youth Connect Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --primary:   #FF6B35;
            --secondary: #F7931E;
            --dark:      #0F0F1A;
            --panel:     #1A1A2E;
            --card:      #242438;
            --border:    rgba(255,255,255,0.07);
            --text:      #E8E8F0;
            --muted:     #8888AA;
            --success:   #2ECC71;
            --danger:    #E74C3C;
            --warning:   #F39C12;
            --info:      #3498DB;
            --purple:    #9B59B6;
            --teal:      #1ABC9C;
            --red-alert: #FF3333;
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--dark);
            color: var(--text);
            min-height: 100vh;
        }

        /* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .layout { display: flex; min-height: 100vh; }

        .sidebar {
            width: 220px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0; left: 0;
            height: 100vh;
            z-index: 100;
            transition: transform 0.3s;
        }

        .sidebar-logo {
            padding: 1.5rem 1.25rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-logo h2 {
            font-family: 'Syne', sans-serif;
            font-size: 1rem;
            color: var(--primary);
            line-height: 1.3;
        }

        .sidebar-logo span {
            font-size: 0.7rem;
            color: var(--muted);
            font-weight: 400;
        }

        .sidebar-nav { flex: 1; padding: 1rem 0; overflow-y: auto; }

        .nav-section {
            padding: 0.5rem 1rem 0.25rem;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--muted);
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0.6rem 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            color: var(--muted);
            border-left: 3px solid transparent;
            text-decoration: none;
        }

        .nav-item:hover, .nav-item.active {
            color: var(--text);
            background: rgba(255,107,53,0.08);
            border-left-color: var(--primary);
        }

        .nav-item.alert-nav { color: #ff6b6b; }
        .nav-item.alert-nav:hover, .nav-item.alert-nav.active {
            background: rgba(231,76,60,0.1);
            border-left-color: var(--danger);
            color: #ff8888;
        }

        .nav-item.teal-nav { color: #4dd9c0; }
        .nav-item.teal-nav:hover, .nav-item.teal-nav.active {
            background: rgba(26,188,156,0.1);
            border-left-color: var(--teal);
            color: #6ee8d0;
        }

        .nav-item i { width: 16px; text-align: center; font-size: 0.85rem; }

        .badge-count {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .badge-count.teal { background: var(--teal); }
        .badge-count.orange { background: var(--primary); }

        .sidebar-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
        }

        .sidebar-footer a {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--muted);
            text-decoration: none;
            font-size: 0.8rem;
            transition: color 0.2s;
        }

        .sidebar-footer a:hover { color: var(--danger); }

        /* â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .main { margin-left: 220px; flex: 1; display: flex; flex-direction: column; }

        .topbar {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 0.875rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .topbar-title { font-family: 'Syne', sans-serif; font-size: 1.1rem; font-weight: 700; }
        .topbar-actions { display: flex; gap: 8px; }

        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            font-size: 0.8rem;
            font-family: 'Space Grotesk', sans-serif;
        }

        .btn-primary  { background: var(--primary);  color: white; }
        .btn-primary:hover  { background: #e85a28; transform: translateY(-1px); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: #e08a1a; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-success { background: var(--success); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-teal { background: var(--teal); color: white; }
        .btn-teal:hover { background: #17a589; }
        .btn-purple { background: var(--purple); color: white; }
        .btn-ghost {
            background: transparent;
            color: var(--muted);
            border: 1px solid var(--border);
        }
        .btn-ghost:hover { color: var(--text); border-color: var(--muted); }
        .btn-sm { padding: 5px 10px; font-size: 0.72rem; }

        .content { padding: 1.5rem; }

        /* â”€â”€ SECTION PANELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .section-panel { display: none; }
        .section-panel.active { display: block; }

        /* â”€â”€ PAGE TITLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .page-title { margin-bottom: 1.5rem; }
        .page-title h1 { font-family: 'Syne', sans-serif; font-size: 1.4rem; font-weight: 800; color: var(--text); }
        .page-title p { font-size: 0.8rem; color: var(--muted); margin-top: 3px; }

        /* â”€â”€ STAT CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .stat-card:hover { transform: translateY(-2px); }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 3px; height: 100%;
            background: var(--primary);
        }

        .stat-card.s-success::after { background: var(--success); }
        .stat-card.s-danger::after  { background: var(--danger); }
        .stat-card.s-warning::after { background: var(--warning); }
        .stat-card.s-info::after    { background: var(--info); }
        .stat-card.s-purple::after  { background: var(--purple); }
        .stat-card.s-teal::after    { background: var(--teal); }

        .stat-icon { font-size: 1.6rem; opacity: 0.12; position: absolute; right: 14px; top: 14px; }

        .stat-val {
            font-family: 'Syne', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            color: var(--text);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.72rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 6px;
        }

        .stat-sub { font-size: 0.7rem; color: var(--muted); margin-top: 3px; }

        /* â”€â”€ CHART CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 1.5rem;
        }

        .chart-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title i { color: var(--primary); font-size: 0.85rem; }

        .chart-wrap { position: relative; height: 220px; }

        /* â”€â”€ VULNERABILITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .vuln-header {
            background: linear-gradient(135deg, rgba(231,76,60,0.15), rgba(155,89,182,0.1));
            border: 1px solid rgba(231,76,60,0.3);
            border-radius: 14px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .vuln-header-icon {
            width: 44px; height: 44px;
            background: rgba(231,76,60,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--danger);
            flex-shrink: 0;
        }

        .vuln-header-text h2 { font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 800; color: #ff8888; }
        .vuln-header-text p { font-size: 0.78rem; color: var(--muted); margin-top: 3px; line-height: 1.5; }

        .vuln-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 1.25rem;
        }

        .vuln-stat {
            background: var(--card);
            border: 1px solid rgba(231,76,60,0.2);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }

        .vuln-stat .v-val { font-family: 'Syne', sans-serif; font-size: 1.8rem; font-weight: 800; color: var(--danger); }
        .vuln-stat .v-label { font-size: 0.7rem; color: var(--muted); margin-top: 4px; line-height: 1.4; }

        .vuln-table-wrap {
            background: var(--card);
            border: 1px solid rgba(231,76,60,0.2);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.25rem;
        }

        .vuln-table-title {
            padding: 0.875rem 1.25rem;
            background: rgba(231,76,60,0.1);
            border-bottom: 1px solid rgba(231,76,60,0.2);
            font-size: 0.85rem;
            font-weight: 600;
            color: #ff8888;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-scroll { overflow-x: auto; }

        .vuln-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.78rem;
            min-width: 580px;
        }

        .vuln-table th {
            background: rgba(0,0,0,0.2);
            padding: 0.7rem 0.875rem;
            text-align: left;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--muted);
            font-weight: 600;
            white-space: nowrap;
        }

        .vuln-table td {
            padding: 0.75rem 0.875rem;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        .vuln-table tr:last-child td { border-bottom: none; }
        .vuln-table tr:hover td { background: rgba(255,255,255,0.03); }

        /* Flag Pills */
        .flag-pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.68rem;
            font-weight: 700;
            white-space: nowrap;
            margin: 2px;
        }

        .flag-red    { background: rgba(231,76,60,0.2);  color: #ff8888; border: 1px solid rgba(231,76,60,0.3); }
        .flag-orange { background: rgba(243,156,18,0.2); color: #f5c842; border: 1px solid rgba(243,156,18,0.3); }
        .flag-purple { background: rgba(155,89,182,0.2); color: #c39bd3; border: 1px solid rgba(155,89,182,0.3); }
        .flag-blue   { background: rgba(52,152,219,0.2); color: #85c1e9; border: 1px solid rgba(52,152,219,0.3); }
        .flag-teal   { background: rgba(26,188,156,0.2); color: #76d7c4; border: 1px solid rgba(26,188,156,0.3); }

        .risk-level { padding: 3px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }
        .risk-critical { background: rgba(255,51,51,0.2);  color: #ff6666; }
        .risk-high     { background: rgba(231,76,60,0.15); color: #e08080; }
        .risk-medium   { background: rgba(243,156,18,0.2); color: #f5c842; }

        /* SRH */
        .srh-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 1.25rem; }

        .srh-bar-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 1rem; }

        .srh-bar-label {
            font-size: 0.78rem;
            color: var(--muted);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        .srh-bar-label span:last-child { font-weight: 700; color: var(--text); }

        .srh-bar-bg { height: 8px; background: rgba(255,255,255,0.07); border-radius: 4px; overflow: hidden; }
        .srh-bar-fill { height: 100%; border-radius: 4px; transition: width 1s ease; }

        /* â”€â”€ QUESTION BREAKDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .q-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 1.5rem; }

        .q-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            border-left: 3px solid var(--info);
            transition: all 0.2s;
        }

        .q-card:hover { transform: translateX(3px); }
        .q-card.q-positive { border-left-color: var(--success); }
        .q-card.q-negative { border-left-color: var(--warning); }
        .q-card.q-critical { border-left-color: var(--danger); background: rgba(231,76,60,0.05); }

        .q-number { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-bottom: 4px; }
        .q-text { font-size: 0.82rem; color: var(--text); line-height: 1.4; margin-bottom: 0.75rem; }
        .q-bar-wrap { display: flex; align-items: center; gap: 10px; }
        .q-bar-bg { flex: 1; height: 6px; background: rgba(255,255,255,0.07); border-radius: 3px; overflow: hidden; }
        .q-bar-fill { height: 100%; border-radius: 3px; }
        .q-avg { font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700; color: var(--primary); min-width: 30px; text-align: right; }
        .q-meta { font-size: 0.7rem; color: var(--muted); margin-top: 5px; }

        /* â”€â”€ DATA TABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .data-table-wrap {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .data-table-head {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .data-table-head h3 { font-size: 0.9rem; font-weight: 600; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.78rem;
            min-width: 700px;
        }

        .data-table th {
            background: rgba(0,0,0,0.2);
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--muted);
            font-weight: 600;
            white-space: nowrap;
        }

        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background: rgba(255,255,255,0.02); }

        .score-badge { padding: 3px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; white-space: nowrap; }
        .sc-critical  { background: rgba(255,51,51,0.2);  color: #ff6666; }
        .sc-high-risk { background: rgba(243,156,18,0.2); color: #f5c842; }
        .sc-moderate  { background: rgba(52,152,219,0.2); color: #85c1e9; }
        .sc-good      { background: rgba(46,204,113,0.2); color: #82e0aa; }
        .sc-excellent { background: rgba(39,174,96,0.2);  color: #58d68d; }

        /* â”€â”€ SERVICE BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .svc-pill { display: inline-flex; align-items: center; gap: 4px; padding: 3px 9px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; white-space: nowrap; }
        .svc-counseling { background: rgba(155,89,182,0.2); color: #c39bd3; border: 1px solid rgba(155,89,182,0.25); }
        .svc-stress     { background: rgba(52,152,219,0.2); color: #85c1e9; border: 1px solid rgba(52,152,219,0.25); }
        .svc-crisis     { background: rgba(231,76,60,0.2);  color: #ff8888; border: 1px solid rgba(231,76,60,0.3); }

        /* â”€â”€ OUTREACH EMAIL COMPOSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .outreach-header {
            background: linear-gradient(135deg, rgba(26,188,156,0.12), rgba(52,152,219,0.08));
            border: 1px solid rgba(26,188,156,0.3);
            border-radius: 14px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .outreach-header-icon {
            width: 44px; height: 44px;
            background: rgba(26,188,156,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--teal);
            flex-shrink: 0;
        }

        .outreach-header-text h2 { font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 800; color: #6ee8d0; }
        .outreach-header-text p { font-size: 0.78rem; color: var(--muted); margin-top: 3px; line-height: 1.5; }

        .outreach-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .outreach-stat {
            background: var(--card);
            border: 1px solid rgba(26,188,156,0.2);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }

        .outreach-stat .o-val { font-family: 'Syne', sans-serif; font-size: 1.8rem; font-weight: 800; color: var(--teal); }
        .outreach-stat .o-label { font-size: 0.7rem; color: var(--muted); margin-top: 4px; line-height: 1.4; }

        /* Priority queue cards */
        .priority-queue { display: flex; flex-direction: column; gap: 10px; margin-bottom: 1.5rem; }

        .pq-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            transition: background 0.2s;
        }

        .pq-card:hover { background: rgba(255,255,255,0.03); }

        .pq-card.pq-critical { border-left: 3px solid var(--danger); }
        .pq-card.pq-high     { border-left: 3px solid var(--warning); }
        .pq-card.pq-medium   { border-left: 3px solid var(--info); }

        .pq-priority {
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 70px;
        }

        .pq-critical .pq-priority { color: var(--danger); }
        .pq-high .pq-priority     { color: var(--warning); }
        .pq-medium .pq-priority   { color: var(--info); }

        .pq-info { flex: 1; min-width: 180px; }
        .pq-email { font-size: 0.85rem; font-weight: 600; color: var(--text); }
        .pq-flags { margin-top: 3px; }
        .pq-actions { display: flex; gap: 6px; flex-wrap: wrap; }

        /* Email Composer Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            z-index: 500;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.open { display: flex; }

        .modal {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 100%;
            max-width: 640px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.25rem 1.5rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--panel);
            z-index: 1;
        }

        .modal-header h3 { font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 800; }
        .modal-header h3 i { color: var(--teal); margin-right: 6px; }
        .modal-close { background: none; border: none; color: var(--muted); font-size: 1.1rem; cursor: pointer; transition: color 0.2s; }
        .modal-close:hover { color: var(--danger); }

        .modal-body { padding: 1.25rem 1.5rem; flex: 1; }

        .modal-recipient-bar {
            background: rgba(26,188,156,0.08);
            border: 1px solid rgba(26,188,156,0.2);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1.25rem;
            font-size: 0.82rem;
        }

        .modal-recipient-bar strong { color: var(--teal); }

        .form-row { margin-bottom: 1rem; }

        .form-row label {
            display: block;
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--muted);
            margin-bottom: 0.4rem;
        }

        .form-row input,
        .form-row select,
        .form-row textarea {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1.5px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.85rem;
            padding: 0.75rem 0.9rem;
            outline: none;
            transition: border-color 0.2s;
            resize: vertical;
        }

        .form-row input:focus,
        .form-row select:focus,
        .form-row textarea:focus { border-color: var(--teal); }

        .form-row textarea { min-height: 140px; }
        .form-row select option { background: var(--dark); }

        .template-chips { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 0.5rem; }

        .template-chip {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            color: var(--muted);
            background: transparent;
            transition: all 0.2s;
            font-family: 'Space Grotesk', sans-serif;
        }

        .template-chip:hover { border-color: var(--teal); color: var(--teal); }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Sent log */
        .sent-log { display: flex; flex-direction: column; gap: 8px; }
        .sent-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.875rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }
        .sent-item-meta { font-size: 0.72rem; color: var(--muted); margin-top: 2px; }
        .sent-item-subject { font-size: 0.85rem; font-weight: 600; }

        /* â”€â”€ FILES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .file-list { display: flex; flex-direction: column; gap: 8px; }

        .file-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .file-name { font-size: 0.85rem; display: flex; align-items: center; gap: 8px; color: var(--text); }
        .file-name i { color: var(--success); }
        .file-actions { display: flex; gap: 8px; }

        /* â”€â”€ MOBILE NAV TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .mobile-toggle {
            display: none;
            position: fixed;
            bottom: 20px; right: 20px;
            width: 48px; height: 48px;
            background: var(--primary);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(255,107,53,0.4);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 99;
        }

        /* â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .empty { text-align: center; padding: 3rem 1rem; color: var(--muted); }
        .empty i { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.3; display: block; }
        .empty p { font-size: 0.85rem; }

        /* â”€â”€ DIVIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .section-divider {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--muted);
            padding: 0.5rem 0;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (min-width: 600px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .vuln-stats { grid-template-columns: repeat(4, 1fr); }
            .outreach-stats { grid-template-columns: repeat(4, 1fr); }
            .charts-grid { grid-template-columns: repeat(2, 1fr); }
            .srh-grid { grid-template-columns: repeat(2, 1fr); }
            .q-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (min-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(4, 1fr); }
            .q-grid { grid-template-columns: repeat(3, 1fr); }
        }

        @media (min-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(6, 1fr); }
        }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay.open { display: block; }
            .mobile-toggle { display: flex; align-items: center; justify-content: center; }
            .main { margin-left: 0; }
            .topbar { padding: 0.75rem 1rem; }
            .content { padding: 1rem; }
        }

        /* Animations */
        @keyframes fadeUp {
            from { opacity:0; transform:translateY(16px); }
            to   { opacity:1; transform:translateY(0); }
        }

        .fade-up { animation: fadeUp 0.4s ease both; }

        @keyframes pulse-red {
            0%,100% { box-shadow: 0 0 0 0 rgba(231,76,60,0.4); }
            50%      { box-shadow: 0 0 0 8px rgba(231,76,60,0); }
        }

        .pulse-red { animation: pulse-red 2s infinite; }

        @keyframes pulse-teal {
            0%,100% { box-shadow: 0 0 0 0 rgba(26,188,156,0.4); }
            50%      { box-shadow: 0 0 0 8px rgba(26,188,156,0); }
        }

        .pulse-teal { animation: pulse-teal 2s infinite; }

        /* search input */
        .search-box {
            background: rgba(255,255,255,0.05);
            border: 1.5px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.82rem;
            padding: 0.5rem 0.875rem;
            outline: none;
            transition: border-color 0.2s;
            width: 200px;
        }

        .search-box:focus { border-color: var(--primary); }
        .search-box::placeholder { color: var(--muted); }
    </style>
</head>
<body>

<!-- â”€â”€ Email Composer Modal â”€â”€ -->
<div class="modal-overlay" id="emailModal">
    <div class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-paper-plane"></i> Compose Outreach Email</h3>
            <button class="modal-close" onclick="closeEmailModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="modal-recipient-bar" id="modalRecipientBar">
                <strong>To:</strong> <span id="modalRecipientEmail">â€”</span>
                &nbsp;&nbsp;|&nbsp;&nbsp;
                <strong>Flags:</strong> <span id="modalRecipientFlags">â€”</span>
            </div>

            <!-- Hidden fields used to build mailto link -->
            <input type="hidden" id="composerTo">

            <div class="form-row">
                <label>Email Template</label>
                <div class="template-chips">
                    <button class="template-chip" onclick="applyTemplate('safety')">ğŸš¨ Safety Check-In</button>
                    <button class="template-chip" onclick="applyTemplate('abuse')">ğŸ’” Abuse Support</button>
                    <button class="template-chip" onclick="applyTemplate('srh')">ğŸŒ¸ SRH Resources</button>
                    <button class="template-chip" onclick="applyTemplate('counseling')">ğŸ§  Counseling Referral</button>
                    <button class="template-chip" onclick="applyTemplate('followup')">ğŸ“‹ General Follow-Up</button>
                </div>
            </div>

            <div class="form-row">
                <label>Subject</label>
                <input type="text" id="composerSubject" placeholder="Email subject lineâ€¦">
            </div>

            <div class="form-row">
                <label>Message Body</label>
                <textarea id="composerBody" placeholder="Compose your message hereâ€¦"></textarea>
            </div>

            <div class="form-row">
                <label>Sender Name / Role (for signature)</label>
                <input type="text" id="composerSender" placeholder="e.g. Youth Connect Hub â€” Welfare Team">
            </div>

            <p style="font-size:0.72rem; color:var(--muted); margin-top:0.5rem;">
                <i class="fas fa-info-circle"></i>
                Clicking <strong>Open in Mail</strong> will launch your system email client with the composed message.
                All communication must follow your safeguarding protocol and institutional guidelines.
            </p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeEmailModal()">Cancel</button>
            <button class="btn btn-teal" onclick="openMailto()">
                <i class="fas fa-paper-plane"></i> Open in Mail
            </button>
            <button class="btn btn-ghost" onclick="copyComposed()">
                <i class="fas fa-copy"></i> Copy
            </button>
        </div>
    </div>
</div>

<div class="layout">

    <!-- â”€â”€ Sidebar â”€â”€ -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <h2>Youth Connect Hub</h2>
            <span>Admin Dashboard</span>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">Overview</div>
            <a class="nav-item active" onclick="showSection('overview', this)">
                <i class="fas fa-chart-pie"></i> Dashboard
            </a>
            <a class="nav-item" onclick="showSection('trends', this)">
                <i class="fas fa-chart-area"></i> Trends
            </a>

            <div class="nav-section" style="margin-top:0.75rem;">Assessment</div>
            <a class="nav-item" onclick="showSection('questions', this)">
                <i class="fas fa-brain"></i> Question Analysis
            </a>
            <a class="nav-item" onclick="showSection('records', this)">
                <i class="fas fa-table"></i> All Records
            </a>

            <div class="nav-section" style="margin-top:0.75rem;">Support Requests</div>
            <a class="nav-item" onclick="showSection('registrations', this)">
                <i class="fas fa-address-card"></i> Registrations
                <span class="badge-count orange" id="reg-count">â€“</span>
            </a>

            <div class="nav-section" style="margin-top:0.75rem;">Safeguarding</div>
            <a class="nav-item alert-nav" onclick="showSection('vulnerability', this)">
                <i class="fas fa-shield-alt"></i> Vulnerability Flags
                <span class="badge-count" id="vuln-count">â€“</span>
            </a>
            <a class="nav-item alert-nav" onclick="showSection('srh', this)">
                <i class="fas fa-heartbeat"></i> SRH Access
            </a>
            <a class="nav-item teal-nav" onclick="showSection('outreach', this)">
                <i class="fas fa-envelope-open-text"></i> Outreach &amp; Email
                <span class="badge-count teal" id="outreach-count">â€“</span>
            </a>

            <div class="nav-section" style="margin-top:0.75rem;">System</div>
            <a class="nav-item" onclick="showSection('files', this)">
                <i class="fas fa-folder"></i> Files
            </a>
        </nav>
        <div class="sidebar-footer">
            <a href="{{ url_for('admin_logout') }}">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </aside>

    <div class="sidebar-overlay" id="overlay" onclick="closeSidebar()"></div>

    <!-- â”€â”€ Main â”€â”€ -->
    <main class="main">
        <div class="topbar">
            <div class="topbar-title" id="section-title">Dashboard Overview</div>
            <div class="topbar-actions">
                <a href="{{ url_for('export_analytics') }}" class="btn btn-ghost">
                    <i class="fas fa-download"></i> <span class="hide-xs">Export</span>
                </a>
                <a href="{{ url_for('download_responses') }}" class="btn btn-secondary">
                    <i class="fas fa-file-excel"></i> <span class="hide-xs">Excel</span>
                </a>
                <a href="{{ url_for('admin_logout') }}" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>

        <div class="content">

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SECTION: DASHBOARD OVERVIEW
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="section-panel active fade-up" id="sec-overview">
                <div class="page-title">
                    <h1>Dashboard Overview</h1>
                    <p>Youth mental wellness assessment data â€” Ondo State</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-clipboard-check stat-icon"></i>
                        <div class="stat-val">{{ analytics.total_assessments }}</div>
                        <div class="stat-label">Total Assessments</div>
                        <div class="stat-sub">All time</div>
                    </div>
                    <div class="stat-card s-info">
                        <i class="fas fa-chart-line stat-icon"></i>
                        <div class="stat-val">{{ analytics.avg_score }}</div>
                        <div class="stat-label">Avg Score</div>
                        <div class="stat-sub">out of 88</div>
                    </div>
                    <div class="stat-card s-danger">
                        <i class="fas fa-exclamation-triangle stat-icon"></i>
                        <div class="stat-val">{{ analytics.risk_categories.critical + analytics.risk_categories.high_risk }}</div>
                        <div class="stat-label">At-Risk Youth</div>
                        <div class="stat-sub">Critical + High Risk</div>
                    </div>
                    <div class="stat-card s-warning">
                        <i class="fas fa-calendar-week stat-icon"></i>
                        <div class="stat-val">{{ analytics.completion_rate_last_7_days }}</div>
                        <div class="stat-label">Last 7 Days</div>
                        <div class="stat-sub">New responses</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-users stat-icon"></i>
                        <div class="stat-val">{{ unique_visitors }}</div>
                        <div class="stat-label">Unique Visitors</div>
                        <div class="stat-sub">{{ total_visits }} total visits</div>
                    </div>
                    <div class="stat-card s-success">
                        <i class="fas fa-trophy stat-icon"></i>
                        <div class="stat-val">{{ analytics.risk_categories.excellent }}</div>
                        <div class="stat-label">Excellent</div>
                        <div class="stat-sub">Score 70â€“88</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="card-title"><i class="fas fa-chart-pie"></i> Score Distribution</div>
                        <div class="chart-wrap"><canvas id="scoreDistChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="card-title"><i class="fas fa-venus-mars"></i> Gender Breakdown</div>
                        <div class="chart-wrap"><canvas id="genderChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="card-title"><i class="fas fa-users"></i> Age Distribution</div>
                        <div class="chart-wrap"><canvas id="ageChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="card-title"><i class="fas fa-chart-area"></i> 30-Day Activity</div>
                        <div class="chart-wrap"><canvas id="trendChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SECTION: TRENDS
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="section-panel" id="sec-trends">
                <div class="page-title">
                    <h1>Trends & Activity</h1>
                    <p>30-day submission activity and score movement</p>
                </div>
                <div class="chart-card" style="margin-bottom:1rem;">
                    <div class="card-title"><i class="fas fa-chart-area"></i> Daily Submissions â€” Last 30 Days</div>
                    <div class="chart-wrap" style="height:300px;">
                        <canvas id="trendChart2"></canvas>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SECTION: QUESTION ANALYSIS
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="section-panel" id="sec-questions">
                <div class="page-title">
                    <h1>Question-by-Question Analysis</h1>
                    <p>Average responses across all 20 assessment questions. Green = positive indicators. Red border = concern area.</p>
                </div>

                <div class="section-divider">ğŸŒ± Wellbeing & Energy (Q1â€“Q5) â€” Higher avg = Better</div>
                <div class="q-grid" style="margin-bottom:1.5rem;">
                    {% for qn in ['q1','q2','q3','q4','q5'] %}
                    {% if qn in analytics.question_averages %}
                    {% set qd = analytics.question_averages[qn] %}
                    <div class="q-card q-positive">
                        <div class="q-number">{{ qn|upper }} Â· Wellbeing</div>
                        <div class="q-text">{{ qd.label }}</div>
                        <div class="q-bar-wrap">
                            <div class="q-bar-bg">
                                <div class="q-bar-fill" style="width:{{ (qd.average/5)*100 }}%; background: var(--success);"></div>
                            </div>
                            <div class="q-avg">{{ qd.average }}</div>
                        </div>
                        <div class="q-meta">{{ qd.total_responses }} responses Â· out of 5</div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>

                <div class="section-divider">ğŸ§  Mental Health Indicators (Q6â€“Q10) â€” Lower avg = Better</div>
                <div class="q-grid" style="margin-bottom:1.5rem;">
                    {% for qn in ['q6','q7','q8','q9','q10'] %}
                    {% if qn in analytics.question_averages %}
                    {% set qd = analytics.question_averages[qn] %}
                    <div class="q-card q-negative {% if qd.average <= 2 %}q-critical{% endif %}">
                        <div class="q-number">{{ qn|upper }} Â· Mental Health</div>
                        <div class="q-text">{{ qd.label }}</div>
                        <div class="q-bar-wrap">
                            <div class="q-bar-bg">
                                <div class="q-bar-fill" style="width:{{ (qd.average/5)*100 }}%; background: {% if qd.average <= 2 %}var(--danger){% else %}var(--warning){% endif %};"></div>
                            </div>
                            <div class="q-avg">{{ qd.average }}</div>
                        </div>
                        <div class="q-meta">{{ qd.total_responses }} responses Â· out of 5 | {% if qd.average <= 2 %}âš  Concern{% else %}Within range{% endif %}</div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>

                <div class="section-divider">ğŸ›¡ï¸ Safety & Sexual Boundaries (Q11â€“Q15) â€” CRITICAL</div>
                <div class="q-grid" style="margin-bottom:1.5rem;">
                    {% for qn, qtype in [('q11','positive'),('q12','critical'),('q13','critical'),('q14','negative'),('q15','positive')] %}
                    {% if qn in analytics.question_averages %}
                    {% set qd = analytics.question_averages[qn] %}
                    <div class="q-card q-{{ qtype }}">
                        <div class="q-number">{{ qn|upper }} Â· Safety / Boundaries</div>
                        <div class="q-text">{{ qd.label }}</div>
                        <div class="q-bar-wrap">
                            <div class="q-bar-bg">
                                <div class="q-bar-fill" style="width:{{ (qd.average/4)*100 }}%; background: {% if qtype=='critical' %}var(--danger){% elif qtype=='positive' %}var(--success){% else %}var(--warning){% endif %};"></div>
                            </div>
                            <div class="q-avg">{{ qd.average }}</div>
                        </div>
                        <div class="q-meta">{{ qd.total_responses }} responses Â· out of 4</div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>

                <div class="section-divider">ğŸŒ¸ SRH Access & Support (Q16â€“Q20)</div>
                <div class="q-grid">
                    {% for qn in ['q16','q17','q18','q19','q20'] %}
                    {% if qn in analytics.question_averages %}
                    {% set qd = analytics.question_averages[qn] %}
                    <div class="q-card q-positive">
                        <div class="q-number">{{ qn|upper }} Â· SRH</div>
                        <div class="q-text">{{ qd.label }}</div>
                        <div class="q-bar-wrap">
                            <div class="q-bar-bg">
                                <div class="q-bar-fill" style="width:{{ (qd.average/4)*100 }}%; background: var(--info);"></div>
                            </div>
                            <div class="q-avg">{{ qd.average }}</div>
                        </div>
                        <div class="q-meta">{{ qd.total_responses }} responses Â· out of 4</div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SECTION: ALL RECORDS
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="section-panel" id="sec-records">
                <div class="page-title">
                    <h1>All Assessment Records</h1>
                    <p>Most recent 50 shown. Download Excel for full export.</p>
                </div>
                {% if assessments %}
                <div class="data-table-wrap">
                    <div class="data-table-head">
                        <h3>{{ assessments|length }} Records</h3>
                        <a href="{{ url_for('download_responses') }}" class="btn btn-secondary">
                            <i class="fas fa-download"></i> Download All
                        </a>
                    </div>
                    <div class="table-scroll">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Date</th>
                                    <th>Email</th>
                                    <th>Age</th>
                                    <th>Sex</th>
                                    <th>Score</th>
                                    <th>Band</th>
                                    <th>Vuln Flag</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for a in assessments[:50] %}
                                {% set score = a.score if a.score else 0 %}
                                {% set is_vuln = (a.q12 and a.q12 >= 3) or (a.q13 and a.q13 >= 3) or (a.q14 and a.q14 >= 3) or (a.q15 and a.q15 <= 2) or (a.q11 and a.q11 <= 2) %}
                                <tr>
                                    <td><strong>#{{ a.id }}</strong></td>
                                    <td style="white-space:nowrap; font-size:0.72rem; color:var(--muted);">{{ a.timestamp }}</td>
                                    <td>{{ a.email }}</td>
                                    <td>{{ a.age }}</td>
                                    <td>{{ a.sex|title }}</td>
                                    <td><strong>{{ a.score if a.score is not none else 'â€“' }}</strong></td>
                                    <td>
                                        {% if score >= 70 %}<span class="score-badge sc-excellent">Excellent</span>
                                        {% elif score >= 52 %}<span class="score-badge sc-good">Good</span>
                                        {% elif score >= 35 %}<span class="score-badge sc-moderate">Moderate</span>
                                        {% elif score >= 18 %}<span class="score-badge sc-high-risk">High Risk</span>
                                        {% else %}<span class="score-badge sc-critical">Critical</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if is_vuln %}
                                        <span style="color:var(--danger); font-size:0.78rem; font-weight:700;">
                                            <i class="fas fa-exclamation-circle"></i> Flagged
                                        </span>
                                        {% else %}
                                        <span style="color:var(--muted); font-size:0.75rem;">â€“</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="empty"><i class="fas fa-clipboard"></i><p>No assessments yet</p></div>
                {% endif %}
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SECTION: REGISTRATIONS  â† NEW
                 Shows all Registration model entries from register.html form
                 Fields: id, name, age (int years), email, phone, service
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="section-panel" id="sec-registrations">
                <div class="page-title">
                    <h1>Support Request Registrations</h1>
                    <p>All submissions from the Get Support / Register form â€” name, contact, age &amp; requested service</p>
                </div>

                {# â”€â”€ KPI mini-stats â”€â”€ #}
                {% set rns = namespace(total=0, counseling=0, stress=0, crisis=0) %}
                {% if registrations is defined %}
                    {% for r in registrations %}
                        {% set rns.total = rns.total + 1 %}
                        {% if r.service == 'counseling' %}{% set rns.counseling = rns.counseling + 1 %}{% endif %}
                        {% if r.service == 'stress' %}{% set rns.stress = rns.stress + 1 %}{% endif %}
                        {% if r.service == 'crisis' %}{% set rns.crisis = rns.crisis + 1 %}{% endif %}
                    {% endfor %}
                {% endif %}

                <div class="stats-grid" style="margin-bottom:1.5rem;">
                    <div class="stat-card s-teal">
                        <i class="fas fa-address-card stat-icon"></i>
                        <div class="stat-val">{{ rns.total }}</div>
                        <div class="stat-label">Total Registrations</div>
                        <div class="stat-sub">All time</div>
                    </div>
                    <div class="stat-card s-purple">
                        <i class="fas fa-comments stat-icon"></i>
                        <div class="stat-val">{{ rns.counseling }}</div>
                        <div class="stat-label">Counseling</div>
                        <div class="stat-sub">Service requested</div>
                    </div>
                    <div class="stat-card s-info">
                        <i class="fas fa-brain stat-icon"></i>
                        <div class="stat-val">{{ rns.stress }}</div>
                        <div class="stat-label">Stress Management</div>
                        <div class="stat-sub">Service requested</div>
                    </div>
                    <div class="stat-card s-danger">
                        <i class="fas fa-circle-exclamation stat-icon"></i>
                        <div class="stat-val">{{ rns.crisis }}</div>
                        <div class="stat-label">Urgent / Crisis</div>
                        <div class="stat-sub">Immediate attention needed</div>
                    </div>
                </div>

                {# Crisis alert banner if there are crisis registrations #}
                {% if rns.crisis > 0 %}
                <div class="vuln-header" style="margin-bottom:1.25rem;">
                    <div class="vuln-header-icon pulse-red">
                        <i class="fas fa-circle-exclamation"></i>
                    </div>
                    <div class="vuln-header-text">
                        <h2>{{ rns.crisis }} Urgent / Crisis Request{{ 's' if rns.crisis != 1 else '' }}</h2>
                        <p>
                            One or more registrants selected <strong>"Urgent Support"</strong> as their service.
                            These individuals require immediate outreach. Use the
                            <strong>Outreach &amp; Email</strong> section or contact them by phone directly.
                        </p>
                    </div>
                </div>
                {% endif %}

                {# Service distribution bar chart #}
                <div class="chart-card" style="margin-bottom:1.25rem;">
                    <div class="card-title"><i class="fas fa-chart-bar"></i> Registrations by Service</div>
                    <div class="chart-wrap" style="height:180px;">
                        <canvas id="regServiceChart"></canvas>
                    </div>
                </div>

                {# â”€â”€ Registrations Table â”€â”€ #}
                {% if registrations is defined and registrations %}
                <div class="data-table-wrap">
                    <div class="data-table-head">
                        <h3>{{ rns.total }} Registrations</h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input class="search-box" type="text" id="regSearch" placeholder="Search name / emailâ€¦" oninput="filterRegTable()">
                            <a href="{{ url_for('admin_registrations') }}" class="btn btn-ghost btn-sm">
                                <i class="fas fa-external-link-alt"></i> Full View
                            </a>
                        </div>
                    </div>
                    <div class="table-scroll">
                        <table class="data-table" id="regTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Name</th>
                                    <th>Age</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Service</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="regTableBody">
                                {% for r in registrations %}
                                <tr data-name="{{ r.name|lower }}" data-email="{{ r.email|lower }}">
                                    <td><strong>#{{ r.id }}</strong></td>
                                    <td>
                                        <span style="font-weight:600;">{{ r.name }}</span>
                                        {% if r.service == 'crisis' %}
                                        <span style="color:var(--danger); font-size:0.68rem; margin-left:4px;">
                                            <i class="fas fa-exclamation-circle"></i> CRISIS
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>{{ r.age }} yrs</td>
                                    <td>
                                        <a href="mailto:{{ r.email }}" style="color:var(--info); text-decoration:none;">
                                            {{ r.email }}
                                        </a>
                                    </td>
                                    <td>
                                        <a href="tel:{{ r.phone }}" style="color:var(--text); text-decoration:none;">
                                            {{ r.phone }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if r.service == 'counseling' %}
                                        <span class="svc-pill svc-counseling"><i class="fas fa-comments"></i> Counseling</span>
                                        {% elif r.service == 'stress' %}
                                        <span class="svc-pill svc-stress"><i class="fas fa-brain"></i> Stress Mgmt</span>
                                        {% elif r.service == 'crisis' %}
                                        <span class="svc-pill svc-crisis"><i class="fas fa-circle-exclamation"></i> Urgent</span>
                                        {% else %}
                                        <span class="svc-pill" style="color:var(--muted); border:1px solid var(--border);">{{ r.service }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div style="display:flex; gap:5px;">
                                            <button class="btn btn-teal btn-sm"
                                                onclick="openEmailModalReg('{{ r.email }}', '{{ r.name }}', '{{ r.service }}')">
                                                <i class="fas fa-envelope"></i> Email
                                            </button>
                                            <a href="tel:{{ r.phone }}" class="btn btn-ghost btn-sm">
                                                <i class="fas fa-phone"></i>
                                            </a>
                                            <form action="{{ url_for('delete_submission', id=r.id) }}" method="POST"
                                                  onsubmit="return confirm('Delete this registration?');" style="display:inline;">
                                                <button type="submit" class="btn btn-danger btn-sm">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="empty">
                    <i class="fas fa-address-card"></i>
                    <p>No support registrations yet. They will appear here once users submit the form.</p>
                </div>
                {% endif %}
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SECTION: ğŸš¨ VULNERABILITY FLAGS
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="section-panel" id="sec-vulnerability">
                <div class="page-title">
                    <h1>Vulnerability & Safeguarding Flags</h1>
                    <p>Respondents identified as at risk based on Q11â€“Q15 safety answers</p>
                </div>

                <div class="vuln-header">
                    <div class="vuln-header-icon pulse-red">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="vuln-header-text">
                        <h2>Safeguarding Alert System</h2>
                        <p>
                            This section flags respondents who indicated active abuse, coercion, or inability to protect themselves.
                            These individuals require follow-up. All data is confidential â€” handle with care and follow your safeguarding protocol.
                        </p>
                    </div>
                </div>

                <div class="vuln-stats">
                    {% set ns = namespace(sexual_abuse=0, physical_abuse=0, coercion=0, cant_say_no=0, unsafe_home=0) %}
                    {% for a in assessments %}
                        {% if a.q12 and a.q12 >= 3 %}{% set ns.sexual_abuse = ns.sexual_abuse + 1 %}{% endif %}
                        {% if a.q13 and a.q13 >= 3 %}{% set ns.physical_abuse = ns.physical_abuse + 1 %}{% endif %}
                        {% if a.q14 and a.q14 >= 3 %}{% set ns.coercion = ns.coercion + 1 %}{% endif %}
                        {% if a.q15 and a.q15 <= 2 %}{% set ns.cant_say_no = ns.cant_say_no + 1 %}{% endif %}
                        {% if a.q11 and a.q11 <= 2 %}{% set ns.unsafe_home = ns.unsafe_home + 1 %}{% endif %}
                    {% endfor %}
                    <div class="vuln-stat">
                        <div class="v-val">{{ ns.sexual_abuse }}</div>
                        <div class="v-label">Sexual Abuse<br>Reported (Q12)</div>
                    </div>
                    <div class="vuln-stat">
                        <div class="v-val">{{ ns.physical_abuse }}</div>
                        <div class="v-label">Physical/Emotional<br>Abuse (Q13)</div>
                    </div>
                    <div class="vuln-stat">
                        <div class="v-val">{{ ns.coercion }}</div>
                        <div class="v-label">Sexual<br>Coercion (Q14)</div>
                    </div>
                    <div class="vuln-stat">
                        <div class="v-val">{{ ns.cant_say_no }}</div>
                        <div class="v-label">Cannot Assert<br>Boundaries (Q15)</div>
                    </div>
                    <div class="vuln-stat">
                        <div class="v-val">{{ ns.unsafe_home }}</div>
                        <div class="v-label">Unsafe Home<br>Environment (Q11)</div>
                    </div>
                </div>

                <div class="vuln-table-wrap">
                    <div class="vuln-table-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Flagged Respondents â€” Require Follow-up
                    </div>
                    <div class="table-scroll">
                        <table class="vuln-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Age</th>
                                    <th>Sex</th>
                                    <th>Score</th>
                                    <th>Active Flags</th>
                                    <th>Risk Level</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set flag_count = namespace(total=0) %}
                                {% for a in assessments %}
                                {% set flags = [] %}
                                {% if a.q11 and a.q11 <= 2 %}{% set flags = flags + ['unsafe_home'] %}{% endif %}
                                {% if a.q12 and a.q12 == 4 %}{% set flags = flags + ['sexual_abuse_now'] %}{% endif %}
                                {% if a.q12 and a.q12 == 3 %}{% set flags = flags + ['sexual_abuse_past'] %}{% endif %}
                                {% if a.q13 and a.q13 == 4 %}{% set flags = flags + ['phys_abuse_now'] %}{% endif %}
                                {% if a.q13 and a.q13 == 3 %}{% set flags = flags + ['phys_abuse_freq'] %}{% endif %}
                                {% if a.q14 and a.q14 >= 3 %}{% set flags = flags + ['coercion'] %}{% endif %}
                                {% if a.q15 and a.q15 <= 2 %}{% set flags = flags + ['no_boundary'] %}{% endif %}
                                {% if flags|length > 0 %}
                                {% set flag_count.total = flag_count.total + 1 %}
                                {# Build a readable flag label string for the email modal #}
                                {% set flag_str = flags|join(', ') %}
                                <tr>
                                    <td>#{{ a.id }}</td>
                                    <td>{{ a.email }}</td>
                                    <td>{{ a.phone }}</td>
                                    <td>{{ a.age }}</td>
                                    <td>{{ a.sex|title }}</td>
                                    <td><strong>{{ a.score if a.score else 'â€“' }}</strong></td>
                                    <td>
                                        {% if 'sexual_abuse_now' in flags %}<span class="flag-pill flag-red"><i class="fas fa-circle"></i> Sexual abuse NOW</span>{% endif %}
                                        {% if 'sexual_abuse_past' in flags %}<span class="flag-pill flag-orange"><i class="fas fa-circle"></i> Sexual abuse ongoing</span>{% endif %}
                                        {% if 'phys_abuse_now' in flags %}<span class="flag-pill flag-red"><i class="fas fa-circle"></i> Physical abuse NOW</span>{% endif %}
                                        {% if 'phys_abuse_freq' in flags %}<span class="flag-pill flag-orange"><i class="fas fa-circle"></i> Frequent abuse</span>{% endif %}
                                        {% if 'coercion' in flags %}<span class="flag-pill flag-purple"><i class="fas fa-circle"></i> Sexual coercion</span>{% endif %}
                                        {% if 'no_boundary' in flags %}<span class="flag-pill flag-orange"><i class="fas fa-circle"></i> Can't say No</span>{% endif %}
                                        {% if 'unsafe_home' in flags %}<span class="flag-pill flag-blue"><i class="fas fa-circle"></i> Unsafe home</span>{% endif %}
                                    </td>
                                    <td>
                                        {% if 'sexual_abuse_now' in flags or 'phys_abuse_now' in flags %}
                                        <span class="risk-level risk-critical">CRITICAL</span>
                                        {% elif flags|length >= 3 %}
                                        <span class="risk-level risk-high">HIGH</span>
                                        {% else %}
                                        <span class="risk-level risk-medium">MEDIUM</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-teal btn-sm"
                                            onclick="openEmailModalVuln('{{ a.email }}', '{{ a.phone }}', '{{ flag_str }}', {% if 'sexual_abuse_now' in flags or 'phys_abuse_now' in flags %}'critical'{% elif flags|length >= 3 %}'high'{% else %}'medium'{% endif %})">
                                            <i class="fas fa-envelope"></i> Email
                                        </button>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                                {% if flag_count.total == 0 %}
                                <tr>
                                    <td colspan="9" style="text-align:center; padding:2rem; color:var(--muted);">
                                        <i class="fas fa-check-circle" style="color:var(--success);"></i> No vulnerability flags detected
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="card-title"><i class="fas fa-chart-bar"></i> Vulnerability Flag Distribution</div>
                    <div class="chart-wrap"><canvas id="vulnChart"></canvas></div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SECTION: SRH ACCESS & SUPPORT
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="section-panel" id="sec-srh">
                <div class="page-title">
                    <h1>Sexual & Reproductive Health Access</h1>
                    <p>Based on Q16â€“Q20 responses â€” measures SRH knowledge, access and support systems</p>
                </div>

                {% set srh = namespace(no_access=0, no_trusted=0, urgent_need=0, no_help_knowledge=0) %}
                {% for a in assessments %}
                    {% if a.q16 and a.q16 == 1 %}{% set srh.no_access = srh.no_access + 1 %}{% endif %}
                    {% if a.q19 and a.q19 == 1 %}{% set srh.no_trusted = srh.no_trusted + 1 %}{% endif %}
                    {% if a.q17 and a.q17 == 1 %}{% set srh.urgent_need = srh.urgent_need + 1 %}{% endif %}
                    {% if a.q20 and a.q20 == 1 %}{% set srh.no_help_knowledge = srh.no_help_knowledge + 1 %}{% endif %}
                {% endfor %}

                <div class="vuln-stats" style="margin-bottom:1.5rem;">
                    <div class="vuln-stat">
                        <div class="v-val">{{ srh.urgent_need }}</div>
                        <div class="v-label">Urgent SRH Need<br>(Q17 = Yes urgently)</div>
                    </div>
                    <div class="vuln-stat">
                        <div class="v-val">{{ srh.no_access }}</div>
                        <div class="v-label">Zero SRH<br>Information Access (Q16)</div>
                    </div>
                    <div class="vuln-stat">
                        <div class="v-val">{{ srh.no_trusted }}</div>
                        <div class="v-label">No Trusted<br>Adult for SRH (Q19)</div>
                    </div>
                    <div class="vuln-stat">
                        <div class="v-val">{{ srh.no_help_knowledge }}</div>
                        <div class="v-label">Unaware of<br>Support Services (Q20)</div>
                    </div>
                </div>

                <div class="chart-card" style="margin-bottom:1rem;">
                    <div class="card-title"><i class="fas fa-heartbeat"></i> SRH Question Averages</div>
                    <div class="srh-grid">
                        {% for qn, label, color in [
                            ('q16','Access to SRH Information','#3498db'),
                            ('q17','Urgent SRH / Contraception Need','#e74c3c'),
                            ('q18','Optimism About the Future','#2ecc71'),
                            ('q19','Trusted Adult for SRH Talks','#9b59b6'),
                            ('q20','Knows Where to Get Confidential Help','#f39c12')
                        ] %}
                        {% if qn in analytics.question_averages %}
                        {% set qd = analytics.question_averages[qn] %}
                        <div class="srh-bar-card">
                            <div class="srh-bar-label">
                                <span>{{ qn|upper }}: {{ label }}</span>
                                <span>{{ qd.average }} / 4</span>
                            </div>
                            <div class="srh-bar-bg">
                                <div class="srh-bar-fill" style="width:{{ (qd.average/4)*100 }}%; background:{{ color }};"></div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="vuln-table-wrap">
                    <div class="vuln-table-title">
                        <i class="fas fa-exclamation-circle"></i>
                        Respondents with Urgent SRH Needs (Q17 = Yes urgently / Q16 = No access)
                    </div>
                    <div class="table-scroll">
                        <table class="vuln-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Age</th>
                                    <th>Sex</th>
                                    <th>SRH Flags</th>
                                    <th>Trusted Adult?</th>
                                    <th>Knows Help?</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set srh_shown = namespace(count=0) %}
                                {% for a in assessments %}
                                {% if (a.q17 and a.q17 == 1) or (a.q16 and a.q16 == 1) or (a.q19 and a.q19 == 1) %}
                                {% set srh_shown.count = srh_shown.count + 1 %}
                                <tr>
                                    <td>#{{ a.id }}</td>
                                    <td>{{ a.email }}</td>
                                    <td>{{ a.phone }}</td>
                                    <td>{{ a.age }}</td>
                                    <td>{{ a.sex|title }}</td>
                                    <td>
                                        {% if a.q17 == 1 %}<span class="flag-pill flag-red">Urgent SRH need</span>{% endif %}
                                        {% if a.q16 == 1 %}<span class="flag-pill flag-orange">No SRH info</span>{% endif %}
                                        {% if a.q17 == 2 %}<span class="flag-pill flag-blue">SRH need (not urgent)</span>{% endif %}
                                    </td>
                                    <td>
                                        {% if a.q19 == 1 %}<span style="color:var(--danger);font-weight:700;">No one</span>
                                        {% elif a.q19 == 2 %}<span style="color:var(--warning);">Maybe 1</span>
                                        {% elif a.q19 >= 3 %}<span style="color:var(--success);">Yes</span>
                                        {% else %}â€“{% endif %}
                                    </td>
                                    <td>
                                        {% if a.q20 == 1 %}<span style="color:var(--danger);font-weight:700;">No idea</span>
                                        {% elif a.q20 == 2 %}<span style="color:var(--warning);">Heard of places</span>
                                        {% elif a.q20 >= 3 %}<span style="color:var(--success);">Yes</span>
                                        {% else %}â€“{% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-teal btn-sm"
                                            onclick="openEmailModalVuln('{{ a.email }}', '{{ a.phone }}', 'SRH urgent need / no SRH access', 'high')">
                                            <i class="fas fa-envelope"></i> Email
                                        </button>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                                {% if srh_shown.count == 0 %}
                                <tr>
                                    <td colspan="9" style="text-align:center; padding:2rem; color:var(--muted);">
                                        <i class="fas fa-check-circle" style="color:var(--success);"></i> No urgent SRH needs flagged
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SECTION: OUTREACH & EMAIL  â† NEW
                 Priority contact queue for sensitive SRH / abuse flags
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="section-panel" id="sec-outreach">
                <div class="page-title">
                    <h1>Outreach & Email Centre</h1>
                    <p>Priority contact queue for respondents with sensitive flags â€” sexual abuse, coercion &amp; urgent SRH needs</p>
                </div>

                <!-- Info banner -->
                <div class="outreach-header">
                    <div class="outreach-header-icon pulse-teal">
                        <i class="fas fa-envelope-open-text"></i>
                    </div>
                    <div class="outreach-header-text">
                        <h2>Sensitive Outreach Protocol</h2>
                        <p>
                            This section surfaces respondents who require a confidential, trauma-informed outreach.
                            Use the pre-written templates or compose a custom message. Always follow your institution's
                            safeguarding and child-protection guidelines before making contact.
                            <strong style="color:#6ee8d0;">Never disclose assessment scores or specific answers in your outreach email.</strong>
                        </p>
                    </div>
                </div>

                <!-- Outreach KPIs -->
                {% set ons = namespace(critical=0, high=0, medium=0, total=0) %}
                {% for a in assessments %}
                    {% set oflags = [] %}
                    {% if a.q12 and a.q12 >= 3 %}{% set oflags = oflags + ['sa'] %}{% endif %}
                    {% if a.q13 and a.q13 >= 3 %}{% set oflags = oflags + ['pa'] %}{% endif %}
                    {% if a.q14 and a.q14 >= 3 %}{% set oflags = oflags + ['co'] %}{% endif %}
                    {% if a.q15 and a.q15 <= 2 %}{% set oflags = oflags + ['nb'] %}{% endif %}
                    {% if a.q17 and a.q17 == 1 %}{% set oflags = oflags + ['srh'] %}{% endif %}
                    {% if oflags|length > 0 %}
                        {% set ons.total = ons.total + 1 %}
                        {% if (a.q12 and a.q12 == 4) or (a.q13 and a.q13 == 4) %}
                            {% set ons.critical = ons.critical + 1 %}
                        {% elif oflags|length >= 2 %}
                            {% set ons.high = ons.high + 1 %}
                        {% else %}
                            {% set ons.medium = ons.medium + 1 %}
                        {% endif %}
                    {% endif %}
                {% endfor %}

                <div class="outreach-stats">
                    <div class="outreach-stat">
                        <div class="o-val" style="color:var(--danger);">{{ ons.critical }}</div>
                        <div class="o-label">ğŸš¨ Critical<br>Immediate contact needed</div>
                    </div>
                    <div class="outreach-stat">
                        <div class="o-val" style="color:var(--warning);">{{ ons.high }}</div>
                        <div class="o-label">âš  High Priority<br>Contact within 24 hrs</div>
                    </div>
                    <div class="outreach-stat">
                        <div class="o-val" style="color:var(--info);">{{ ons.medium }}</div>
                        <div class="o-label">ğŸ“‹ Medium Priority<br>Contact within 48â€“72 hrs</div>
                    </div>
                    <div class="outreach-stat">
                        <div class="o-val">{{ ons.total }}</div>
                        <div class="o-label">Total Requiring<br>Outreach</div>
                    </div>
                </div>

                <!-- Priority Queue -->
                <div class="section-divider">ğŸš¨ Priority Contact Queue</div>

                {% set pq_shown = namespace(n=0) %}
                <div class="priority-queue">

                    {# â”€â”€ CRITICAL first (active abuse NOW) â”€â”€ #}
                    {% for a in assessments %}
                    {% if (a.q12 and a.q12 == 4) or (a.q13 and a.q13 == 4) %}
                    {% set pq_shown.n = pq_shown.n + 1 %}
                    <div class="pq-card pq-critical">
                        <div class="pq-priority">ğŸš¨ CRITICAL</div>
                        <div class="pq-info">
                            <div class="pq-email">{{ a.email }}</div>
                            <div class="pq-flags">
                                {% if a.q12 == 4 %}<span class="flag-pill flag-red">Sexual abuse â€” happening NOW</span>{% endif %}
                                {% if a.q13 == 4 %}<span class="flag-pill flag-red">Physical abuse â€” happening NOW</span>{% endif %}
                                {% if a.q14 and a.q14 >= 3 %}<span class="flag-pill flag-purple">Sexual coercion</span>{% endif %}
                                {% if a.q17 == 1 %}<span class="flag-pill flag-orange">Urgent SRH need</span>{% endif %}
                            </div>
                            <div class="sent-item-meta">ID #{{ a.id }} Â· Age {{ a.age }} Â· {{ a.sex|title }}
                                {% if a.phone %} Â· ğŸ“ {{ a.phone }}{% endif %}
                            </div>
                        </div>
                        <div class="pq-actions">
                            <button class="btn btn-danger btn-sm"
                                onclick="openEmailModalVuln('{{ a.email }}', '{{ a.phone }}', 'active sexual/physical abuse NOW', 'critical')">
                                <i class="fas fa-envelope"></i> Email Now
                            </button>
                            {% if a.phone %}
                            <a href="tel:{{ a.phone }}" class="btn btn-ghost btn-sm">
                                <i class="fas fa-phone"></i> Call
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}

                    {# â”€â”€ HIGH priority (ongoing abuse / multiple flags / urgent SRH) â”€â”€ #}
                    {% for a in assessments %}
                    {% set hflags = [] %}
                    {% if a.q12 and a.q12 == 3 %}{% set hflags = hflags + ['sa_past'] %}{% endif %}
                    {% if a.q13 and a.q13 == 3 %}{% set hflags = hflags + ['pa_freq'] %}{% endif %}
                    {% if a.q14 and a.q14 >= 3 %}{% set hflags = hflags + ['coercion'] %}{% endif %}
                    {% if a.q15 and a.q15 <= 2 %}{% set hflags = hflags + ['no_boundary'] %}{% endif %}
                    {% if a.q17 and a.q17 == 1 %}{% set hflags = hflags + ['srh_urgent'] %}{% endif %}
                    {# Exclude already shown as critical #}
                    {% if hflags|length >= 2 and not ((a.q12 and a.q12 == 4) or (a.q13 and a.q13 == 4)) %}
                    {% set pq_shown.n = pq_shown.n + 1 %}
                    <div class="pq-card pq-high">
                        <div class="pq-priority">âš  HIGH</div>
                        <div class="pq-info">
                            <div class="pq-email">{{ a.email }}</div>
                            <div class="pq-flags">
                                {% if 'sa_past' in hflags %}<span class="flag-pill flag-orange">Sexual abuse â€” ongoing</span>{% endif %}
                                {% if 'pa_freq' in hflags %}<span class="flag-pill flag-orange">Frequent physical abuse</span>{% endif %}
                                {% if 'coercion' in hflags %}<span class="flag-pill flag-purple">Sexual coercion</span>{% endif %}
                                {% if 'no_boundary' in hflags %}<span class="flag-pill flag-orange">Cannot say No</span>{% endif %}
                                {% if 'srh_urgent' in hflags %}<span class="flag-pill flag-red">Urgent SRH need</span>{% endif %}
                            </div>
                            <div class="sent-item-meta">ID #{{ a.id }} Â· Age {{ a.age }} Â· {{ a.sex|title }}
                                {% if a.phone %} Â· ğŸ“ {{ a.phone }}{% endif %}
                            </div>
                        </div>
                        <div class="pq-actions">
                            <button class="btn btn-teal btn-sm"
                                onclick="openEmailModalVuln('{{ a.email }}', '{{ a.phone }}', 'ongoing abuse / coercion / urgent SRH', 'high')">
                                <i class="fas fa-envelope"></i> Email
                            </button>
                            {% if a.phone %}
                            <a href="tel:{{ a.phone }}" class="btn btn-ghost btn-sm">
                                <i class="fas fa-phone"></i> Call
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}

                    {# â”€â”€ MEDIUM priority (single flags) â”€â”€ #}
                    {% for a in assessments %}
                    {% set mflags = [] %}
                    {% if a.q12 and a.q12 == 3 %}{% set mflags = mflags + ['sa'] %}{% endif %}
                    {% if a.q13 and a.q13 == 3 %}{% set mflags = mflags + ['pa'] %}{% endif %}
                    {% if a.q14 and a.q14 >= 3 %}{% set mflags = mflags + ['co'] %}{% endif %}
                    {% if a.q15 and a.q15 <= 2 %}{% set mflags = mflags + ['nb'] %}{% endif %}
                    {% if a.q11 and a.q11 <= 2 %}{% set mflags = mflags + ['uh'] %}{% endif %}
                    {% if a.q17 and a.q17 == 1 %}{% set mflags = mflags + ['srh'] %}{% endif %}
                    {# Only show if exactly 1 flag and NOT already shown as critical or high #}
                    {% if mflags|length == 1 and not ((a.q12 and a.q12 == 4) or (a.q13 and a.q13 == 4)) %}
                    {% set pq_shown.n = pq_shown.n + 1 %}
                    <div class="pq-card pq-medium">
                        <div class="pq-priority">ğŸ“‹ MEDIUM</div>
                        <div class="pq-info">
                            <div class="pq-email">{{ a.email }}</div>
                            <div class="pq-flags">
                                {% if 'sa' in mflags %}<span class="flag-pill flag-orange">Sexual abuse â€” reported</span>{% endif %}
                                {% if 'pa' in mflags %}<span class="flag-pill flag-orange">Frequent abuse â€” reported</span>{% endif %}
                                {% if 'co' in mflags %}<span class="flag-pill flag-purple">Sexual coercion</span>{% endif %}
                                {% if 'nb' in mflags %}<span class="flag-pill flag-blue">Boundary concerns</span>{% endif %}
                                {% if 'uh' in mflags %}<span class="flag-pill flag-blue">Unsafe home</span>{% endif %}
                                {% if 'srh' in mflags %}<span class="flag-pill flag-orange">Urgent SRH need</span>{% endif %}
                            </div>
                            <div class="sent-item-meta">ID #{{ a.id }} Â· Age {{ a.age }} Â· {{ a.sex|title }}
                                {% if a.phone %} Â· ğŸ“ {{ a.phone }}{% endif %}
                            </div>
                        </div>
                        <div class="pq-actions">
                            <button class="btn btn-info btn-sm"
                                onclick="openEmailModalVuln('{{ a.email }}', '{{ a.phone }}', '{{ mflags|join(', ') }}', 'medium')">
                                <i class="fas fa-envelope"></i> Email
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}

                    {% if pq_shown.n == 0 %}
                    <div class="empty" style="background:var(--card); border:1px solid var(--border); border-radius:12px;">
                        <i class="fas fa-check-circle" style="color:var(--success);"></i>
                        <p>No sensitive flags requiring outreach. All clear.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- â”€â”€ Bulk email crisis registrants â”€â”€ -->
                {% if rns is defined and rns.crisis > 0 %}
                <div class="section-divider" style="margin-top:2rem;">ğŸ“® Crisis Support Registrations â€” Pending Contact</div>
                <div class="priority-queue">
                    {% if registrations is defined %}
                    {% for r in registrations %}
                    {% if r.service == 'crisis' %}
                    <div class="pq-card pq-critical">
                        <div class="pq-priority">ğŸš¨ CRISIS REG</div>
                        <div class="pq-info">
                            <div class="pq-email">{{ r.name }} &nbsp;Â·&nbsp; {{ r.email }}</div>
                            <div class="pq-flags">
                                <span class="flag-pill flag-red">Requested Urgent Support via Register form</span>
                            </div>
                            <div class="sent-item-meta">Age {{ r.age }} Â· ğŸ“ {{ r.phone }}</div>
                        </div>
                        <div class="pq-actions">
                            <button class="btn btn-danger btn-sm"
                                onclick="openEmailModalReg('{{ r.email }}', '{{ r.name }}', 'crisis')">
                                <i class="fas fa-envelope"></i> Email
                            </button>
                            <a href="tel:{{ r.phone }}" class="btn btn-ghost btn-sm">
                                <i class="fas fa-phone"></i> Call
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}

                <!-- â”€â”€ Email Template Reference â”€â”€ -->
                <div class="section-divider" style="margin-top:2rem;">âœ‰ Email Template Reference</div>
                <div class="charts-grid" style="grid-template-columns: 1fr;">
                    <div class="chart-card">
                        <div class="card-title"><i class="fas fa-book-open"></i> Available Templates</div>
                        <div style="display:grid; gap:10px;">
                            {% set templates = [
                                ('ğŸš¨ Safety Check-In', 'safety', 'For respondents flagged with active or recent abuse. Opens a gentle, non-intrusive check-in.', 'var(--danger)'),
                                ('ğŸ’” Abuse Support', 'abuse', 'Trauma-informed message directing to professional support and crisis lines.', 'var(--purple)'),
                                ('ğŸŒ¸ SRH Resources', 'srh', 'For urgent SRH needs â€” provides information about reproductive health services and support.', 'var(--info)'),
                                ('ğŸ§  Counseling Referral', 'counseling', 'Refers the individual to a Youth Connect counselor with a warm handoff message.', 'var(--success)'),
                                ('ğŸ“‹ General Follow-Up', 'followup', 'Neutral, supportive follow-up for medium-priority flags or registration requests.', 'var(--warning)')
                            ] %}
                            {% for label, key, desc, color in templates %}
                            <div style="background:rgba(255,255,255,0.03); border:1px solid var(--border); border-left:3px solid {{ color }}; border-radius:10px; padding:0.875rem 1rem; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                                <div>
                                    <div style="font-weight:700; font-size:0.85rem;">{{ label }}</div>
                                    <div style="font-size:0.75rem; color:var(--muted); margin-top:3px;">{{ desc }}</div>
                                </div>
                                <button class="btn btn-ghost btn-sm" onclick="previewTemplate('{{ key }}')">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SECTION: FILES
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="section-panel" id="sec-files">
                <div class="page-title">
                    <h1>File Management</h1>
                    <p>Download or clear response exports</p>
                </div>
                {% if files %}
                <div class="file-list">
                    {% for file in files %}
                    <div class="file-item">
                        <div class="file-name">
                            <i class="fas fa-file-excel"></i> {{ file }}
                        </div>
                        <div class="file-actions">
                            <a href="{{ url_for('download_responses') }}" class="btn btn-success">
                                <i class="fas fa-download"></i> Download
                            </a>
                            <form action="{{ url_for('clear_excel') }}" method="POST"
                                  onsubmit="return confirm('Clear all responses? This cannot be undone.');"
                                  style="display:inline;">
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty">
                    <i class="fas fa-folder-open"></i>
                    <p>No files available</p>
                </div>
                {% endif %}
            </div>

        </div><!-- /content -->
    </main>
</div>

<button class="mobile-toggle" id="mobileToggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<script>
    // â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const sectionMap = {
        'overview':       { id: 'sec-overview',       title: 'Dashboard Overview' },
        'trends':         { id: 'sec-trends',          title: 'Trends & Activity' },
        'questions':      { id: 'sec-questions',       title: 'Question Analysis' },
        'records':        { id: 'sec-records',         title: 'All Records' },
        'registrations':  { id: 'sec-registrations',  title: 'ğŸ“‹ Support Registrations' },
        'vulnerability':  { id: 'sec-vulnerability',   title: 'ğŸš¨ Vulnerability Flags' },
        'srh':            { id: 'sec-srh',             title: 'SRH Access & Support' },
        'outreach':       { id: 'sec-outreach',        title: 'âœ‰ Outreach & Email Centre' },
        'files':          { id: 'sec-files',           title: 'File Management' },
    };

    function showSection(key, el) {
        document.querySelectorAll('.section-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const sec = sectionMap[key];
        if (sec) {
            document.getElementById(sec.id).classList.add('active');
            document.getElementById('section-title').textContent = sec.title;
        }
        if (el) el.classList.add('active');
        closeSidebar();
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('open');
    }

    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('overlay').classList.remove('open');
    }

    // â”€â”€ Badge counts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function setBadges() {
        // Vulnerability count
        {% set vc = namespace(n=0) %}
        {% for a in assessments %}
        {% if (a.q12 and a.q12 >= 3) or (a.q13 and a.q13 >= 3) or (a.q14 and a.q14 >= 3) or (a.q15 and a.q15 <= 2) or (a.q11 and a.q11 <= 2) %}
        {% set vc.n = vc.n + 1 %}
        {% endif %}
        {% endfor %}
        const vEl = document.getElementById('vuln-count');
        if (vEl) vEl.textContent = '{{ vc.n }}';

        // Outreach priority count
        {% set oc = namespace(n=0) %}
        {% for a in assessments %}
        {% if (a.q12 and a.q12 >= 3) or (a.q13 and a.q13 >= 3) or (a.q14 and a.q14 >= 3) or (a.q17 and a.q17 == 1) %}
        {% set oc.n = oc.n + 1 %}
        {% endif %}
        {% endfor %}
        const oEl = document.getElementById('outreach-count');
        if (oEl) oEl.textContent = '{{ oc.n }}';

        // Registrations count
        {% set rc = namespace(n=0) %}
        {% if registrations is defined %}
        {% for r in registrations %}{% set rc.n = rc.n + 1 %}{% endfor %}
        {% endif %}
        const rEl = document.getElementById('reg-count');
        if (rEl) rEl.textContent = '{{ rc.n }}';
    })();

    // â”€â”€ Registration table search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function filterRegTable() {
        const q = document.getElementById('regSearch').value.toLowerCase();
        document.querySelectorAll('#regTableBody tr').forEach(row => {
            const name  = row.dataset.name  || '';
            const email = row.dataset.email || '';
            row.style.display = (name.includes(q) || email.includes(q)) ? '' : 'none';
        });
    }

    // â”€â”€ Email Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openEmailModalVuln(email, phone, flagsDesc, priority) {
        document.getElementById('composerTo').value = email;
        document.getElementById('modalRecipientEmail').textContent = email;
        document.getElementById('modalRecipientFlags').textContent = flagsDesc;
        document.getElementById('composerSubject').value = '';
        document.getElementById('composerBody').value = '';
        document.getElementById('composerSender').value = 'Youth Connect Hub â€” Welfare & Safeguarding Team';

        // Auto-apply template based on priority
        if (priority === 'critical') applyTemplate('abuse');
        else if (priority === 'high') applyTemplate('safety');
        else applyTemplate('followup');

        document.getElementById('emailModal').classList.add('open');
    }

    function openEmailModalReg(email, name, service) {
        document.getElementById('composerTo').value = email;
        document.getElementById('modalRecipientEmail').textContent = email;
        document.getElementById('modalRecipientFlags').textContent = 'Registration â€” service: ' + service;
        document.getElementById('composerSender').value = 'Youth Connect Hub â€” Support Team';

        if (service === 'crisis') applyTemplate('safety');
        else if (service === 'counseling') applyTemplate('counseling');
        else applyTemplate('followup');

        document.getElementById('emailModal').classList.add('open');
    }

    function closeEmailModal() {
        document.getElementById('emailModal').classList.remove('open');
    }

    // â”€â”€ Email templates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const templates = {
        safety: {
            subject: 'A Message of Support â€” Youth Connect Hub',
            body: `Dear Friend,

We are reaching out from the Youth Connect Hub, Ondo State Ministry of Health.

We care about your wellbeing and want to make sure you are safe. If you are going through a difficult time right now, please know that you are not alone and support is available.

You can reach our confidential support line at any time:
ğŸ“ +234 813 481 2419

Your safety matters to us. If you are in immediate danger, please contact emergency services or a trusted adult near you.

We are here whenever you are ready to talk.

Warm regards,`
        },
        abuse: {
            subject: 'Confidential Support Available for You â€” Youth Connect Hub',
            body: `Dear Friend,

We are writing to you confidentially from the Youth Connect Hub.

We want you to know that whatever you may be experiencing, you deserve to be safe and supported. If someone has hurt you or is hurting you, it is not your fault â€” and there is help available.

Our trained counselors are ready to speak with you, completely confidentially:
ğŸ“ +234 813 481 2419

If you are in immediate danger, please reach out to someone you trust or contact emergency services.

You are brave, and you do not have to face this alone.

With care,`
        },
        srh: {
            subject: 'Health Resources & Support â€” Youth Connect Hub',
            body: `Dear Friend,

We are reaching out from the Youth Connect Hub, Ondo State Ministry of Health.

We want to make sure you have access to the health information and support you need. Our team can connect you with confidential sexual and reproductive health services, guidance, and trained professionals.

To access free, confidential SRH support, please contact us:
ğŸ“ +234 813 481 2419

Your health and privacy are our priority.

Warm regards,`
        },
        counseling: {
            subject: 'Your Counseling Support â€” Youth Connect Hub',
            body: `Dear Friend,

Thank you for reaching out to Youth Connect Hub.

We have received your request and one of our qualified counselors would like to connect with you. Please contact us at your convenience to schedule a confidential session:

ğŸ“ +234 813 481 2419

Sessions are free, confidential, and available to all Ondo State youth. We look forward to walking this journey with you.

Warm regards,`
        },
        followup: {
            subject: 'Checking In â€” Youth Connect Hub',
            body: `Dear Friend,

We hope this message finds you well.

We are reaching out from Youth Connect Hub as part of our ongoing commitment to youth mental wellness in Ondo State. We just want to check in and let you know that our team is available to support you.

If you ever need to talk, access resources, or simply want more information, we are here:
ğŸ“ +234 813 481 2419
ğŸŒ Visit us at your nearest health centre

Take good care of yourself.

Warm regards,`
        }
    };

    function applyTemplate(key) {
        const t = templates[key];
        if (!t) return;
        const sender = document.getElementById('composerSender').value || 'Youth Connect Hub â€” Welfare Team';
        document.getElementById('composerSubject').value = t.subject;
        document.getElementById('composerBody').value = t.body + '\n' + sender;
    }

    function previewTemplate(key) {
        // Open modal in preview mode with blank recipient
        document.getElementById('composerTo').value = '';
        document.getElementById('modalRecipientEmail').textContent = '(preview â€” no recipient set)';
        document.getElementById('modalRecipientFlags').textContent = 'Template preview';
        document.getElementById('composerSender').value = 'Youth Connect Hub â€” Welfare Team';
        applyTemplate(key);
        document.getElementById('emailModal').classList.add('open');
    }

    function openMailto() {
        const to      = document.getElementById('composerTo').value.trim();
        const subject = document.getElementById('composerSubject').value.trim();
        const body    = document.getElementById('composerBody').value.trim();
        if (!to) { alert('No recipient email address set.'); return; }
        const link = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = link;
    }

    function copyComposed() {
        const subject = document.getElementById('composerSubject').value;
        const body    = document.getElementById('composerBody').value;
        const text = `Subject: ${subject}\n\n${body}`;
        navigator.clipboard.writeText(text).then(() => {
            const btn = event.target.closest('button');
            const orig = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => btn.innerHTML = orig, 2000);
        });
    }

    // â”€â”€ Chart.js Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Chart.defaults.color = '#8888AA';
    Chart.defaults.borderColor = 'rgba(255,255,255,0.06)';

    const isMobile = window.innerWidth < 600;

    const baseOpts = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: isMobile ? 'bottom' : 'right',
                labels: { padding: 12, font: { size: isMobile ? 10 : 11, family: 'Space Grotesk' }, color: '#8888AA' }
            }
        }
    };

    const barScales = {
        scales: {
            y: { beginAtZero: true, ticks: { precision: 0, font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
            x: { ticks: { font: { size: 10 } }, grid: { display: false } }
        }
    };

    // Score Distribution
    {% if analytics.score_distribution %}
    new Chart(document.getElementById('scoreDistChart'), {
        type: 'doughnut',
        data: {
            labels: {{ analytics.score_distribution.keys()|list|tojson }},
            datasets: [{
                data: {{ analytics.score_distribution.values()|list|tojson }},
                backgroundColor: ['#E74C3C','#F39C12','#3498DB','#2ECC71','#27AE60'],
                borderWidth: 2,
                borderColor: '#1A1A2E'
            }]
        },
        options: { ...baseOpts, cutout: '65%' }
    });
    {% endif %}

    // Gender
    {% if analytics.gender_breakdown %}
    new Chart(document.getElementById('genderChart'), {
        type: 'bar',
        data: {
            labels: ['Male','Female','Other'],
            datasets: [{
                data: [{{ analytics.gender_breakdown.male }},{{ analytics.gender_breakdown.female }},{{ analytics.gender_breakdown.other }}],
                backgroundColor: ['#3498DB','#FF6B35','#9B59B6'],
                borderRadius: 6, borderWidth: 0
            }]
        },
        options: { ...baseOpts, plugins: { legend: { display: false } }, ...barScales }
    });
    {% endif %}

    // Age
    {% if analytics.age_distribution %}
    new Chart(document.getElementById('ageChart'), {
        type: 'bar',
        data: {
            labels: {{ analytics.age_distribution.keys()|list|tojson }},
            datasets: [{
                data: {{ analytics.age_distribution.values()|list|tojson }},
                backgroundColor: '#F7931E',
                borderRadius: 6, borderWidth: 0
            }]
        },
        options: { ...baseOpts, plugins: { legend: { display: false } }, ...barScales }
    });
    {% endif %}

    // Trend
    {% if analytics.recent_trend %}
    const tDates  = [];
    const tCounts = [];
    {% for item in analytics.recent_trend %}
    tDates.push('{{ item.date }}');
    tCounts.push({{ item.count }});
    {% endfor %}

    const trendDataset = {
        labels: tDates,
        datasets: [{
            label: 'Assessments',
            data: tCounts,
            borderColor: '#FF6B35',
            backgroundColor: 'rgba(255,107,53,0.08)',
            tension: 0.4, fill: true, pointRadius: 3,
            pointBackgroundColor: '#FF6B35'
        }]
    };

    const trendOpts = {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, ticks: { precision:0, font:{size:10} }, grid:{color:'rgba(255,255,255,0.05)'} },
            x: { ticks: { maxRotation:45, minRotation:45, font:{size:9} }, grid:{display:false} }
        }
    };

    new Chart(document.getElementById('trendChart'), { type:'line', data:trendDataset, options:trendOpts });
    const t2 = document.getElementById('trendChart2');
    if (t2) new Chart(t2, { type:'line', data:trendDataset, options:{...trendOpts, maintainAspectRatio:false} });
    {% endif %}

    // Vulnerability Bar Chart
    const vulnEl = document.getElementById('vulnChart');
    if (vulnEl) {
        {% set ns2 = namespace(sa=0,pa=0,co=0,bn=0,uh=0) %}
        {% for a in assessments %}
            {% if a.q12 and a.q12 >= 3 %}{% set ns2.sa = ns2.sa + 1 %}{% endif %}
            {% if a.q13 and a.q13 >= 3 %}{% set ns2.pa = ns2.pa + 1 %}{% endif %}
            {% if a.q14 and a.q14 >= 3 %}{% set ns2.co = ns2.co + 1 %}{% endif %}
            {% if a.q15 and a.q15 <= 2 %}{% set ns2.bn = ns2.bn + 1 %}{% endif %}
            {% if a.q11 and a.q11 <= 2 %}{% set ns2.uh = ns2.uh + 1 %}{% endif %}
        {% endfor %}
        new Chart(vulnEl, {
            type: 'bar',
            data: {
                labels: ['Sexual Abuse\n(Q12)','Physical Abuse\n(Q13)','Sexual Coercion\n(Q14)',"Can't Say No\n(Q15)",'Unsafe Home\n(Q11)'],
                datasets: [{
                    data: [{{ ns2.sa }},{{ ns2.pa }},{{ ns2.co }},{{ ns2.bn }},{{ ns2.uh }}],
                    backgroundColor: ['#E74C3C','#C0392B','#9B59B6','#F39C12','#3498DB'],
                    borderRadius: 6, borderWidth: 0
                }]
            },
            options: { ...baseOpts, plugins: { legend: { display: false } }, ...barScales }
        });
    }

    // Registrations Service Chart
    const regSvcEl = document.getElementById('regServiceChart');
    if (regSvcEl) {
        new Chart(regSvcEl, {
            type: 'bar',
            data: {
                labels: ['Counseling', 'Stress Management', 'Urgent / Crisis'],
                datasets: [{
                    data: [{{ rns.counseling }}, {{ rns.stress }}, {{ rns.crisis }}],
                    backgroundColor: ['#9B59B6','#3498DB','#E74C3C'],
                    borderRadius: 8, borderWidth: 0
                }]
            },
            options: { ...baseOpts, plugins: { legend: { display: false } }, ...barScales }
        });
    }

    // Auto-refresh every 5 minutes
    setTimeout(() => location.reload(), 300000);
</script>
</body>
</html>